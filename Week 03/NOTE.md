# 课程第三周

> AST相关：LL算法构建AST语法树

# 前言

AST（抽象语法树）是源代码的抽象语法结构的树状表示，树上的每一个节点都表示源代码中的与众结构，之所以说是抽象的，是因为抽象语法树并不会表示真是语法出现的米一个细节，如嵌套括号被隐含在树的结构中，并没有以节点的形式呈现。

抽象语法树在很多领域有广泛的应用，如浏览器、只能编辑器、编译器等

# 正文

## AST的文法解析

当在源程序语法分析工作时，实在相应程序设计语言的语法规则指导下进行的。语法规则描述了该语言的各种语法成分的组成结构，通常可以用所谓的前后文无关文法或与之等价的Backus-Naur范式（BNF）将一个程序设计语言的语法规则确切的描述出来。前后文无关文法分为以下几类：LL（1）、LR（0）、LR（1）、LR（k）、LALR（1）等。每一种文法都有不同的要求，如LL（1）要求文法无二义性和不存左递归。当把一个文法改成LL（1）文法时，需要引入一些额外的文法符号与产生式

##  AST的基本特点

-   特点一：不依赖于具体的文法

无论是LL(1)文法，还是LR(1)，或者还是其它的方法，都要求在语法分析时候，构造出相同的语法树，这样可以给编译器后端提供了清晰，统一的接口。即使是前端采用了不同的文法，都只需要改变前端代码，而不用连累到后端。即减少了工作量，也提高的编译器的可维护性。

-   特点二：不依赖于语言的细节

在编译器家族中，大名鼎鼎的gcc算得上是一个老大哥了，它可以编译多种语言，例如c，c＋＋，java，ADA，Object C， FORTRAN， PASCAL， COBOL等等。在前端gcc对不同的语言进行词法，语法分析和语义分析后，产生抽象语法树形成中间代码作为输出，供后端处理。要做到这一点，就必须在构造语法树时，不依赖于语言的细节，例如在不同的语言中，类似于if－condition－then这样的语句有不同的表示方法

前端工程项目中，查看对应的devDependencies，会发现有很多的依赖插件，如javascript转义、代码压缩、css预处理器、eslint、prettier等，很多都是在开发过程中充当着重要的角色，所有的上述的工具，都是建立在AST这个巨人的肩膀上。

## AST的构建流程

AST的法构建流程分为词法分析和语法分析，分别执行不同的操作

- 词法分析

词法分析，也叫扫描scanner，通过读取代码字符串，按照预定的规则合并成一个个表示tokens。同时也会移除空白符、注释等。最终会整个代码分割成tokens列表

```
const a = 5;
// 转换成
[{value: 'const', type: 'keyword'}, {value: 'a', type: 'identifier'}, ...]
```

在词法分析过程中，通过一个一个字符的读取代码，称之为扫描 - scans，当遇到空格、操作符或者特殊符号是，则认为一个token完成。当然也可以通过正则表达式来获取特定的案例token

- 语法分析

语法分析是在词法分析的基础上，将tokens数组转转成树状结构，同时验证语法是否正确，如果有错则跑出语法错误。

```
[
{value: 'const', type: 'keyword'},
{value: 'a', type: 'identifier'}, 
]
// 语法分析后的树形形式
{
   type: "VariableDeclarator", 
   id: {
       type: "Identifier",
       name: "a"
   },
   ...
}
```

当在生成树的时候，解析器会删除一些没必要的表示tokens（如：不完整的括号），因此AST不是100%与源代码匹配的

而语法分析，最著名的语法分析算法的核心思想有两种：

- LL算法

> LL解析是从左到右，最左边的导数。也就是说，我们考虑从左到右的输入符号，并尝试构造最左边的导数。这是通过从开始符号开始并重复扩展最左边的非终结符，直到我们到达目标字符串。

- LR算法

> LR解析是从左到右，最右边的导数，意味着我们从左到右扫描，并尝试构造最右边的导数。解析器连续选择输入的子串，并尝试将其反转回非终结符。

关于 LL算法和LR算法的具体区别和联系，可以查看文档 [LL and LR Parsing Demystified](https://blog.reverberate.org/2013/07/ll-and-lr-parsing-demystified.html)

对于JavaScript的AST的结构描述，可以通过库 [recast](https://www.npmjs.com/package/recast) 来解析和操作AST结构

## 总结

在JavaScript中，可以通过将源代码经过词法解析和语法解析转换成一个完整的AST结构树，遍历并对指定的AST节点做对应修改，就可以转换或改写代码信息，生成目标代码，虽然业务中可能用不到，但实际开发过程中的很多工具都是基于AST来优化构建项目代码

# 参考文章

-	[1] [LL和LR解析之间有什么区别？](http://www.voidcn.com/article/p-rbetblxn-bsh.html)
-	[2] [我在真实项目中使用了 AST 大法！](https://zhuanlan.zhihu.com/p/96099779)
-	[3] [前端AST入门](https://juejin.cn/post/6903432652104138759)